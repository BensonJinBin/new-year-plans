# Supabase 设置指南

本指南将帮助你完成 Supabase 的配置，使应用支持多用户登录和数据持久化。

## 步骤 1: 创建 Supabase 项目

1. 访问 [https://supabase.com](https://supabase.com)
2. 点击 "Start your project"
3. 使用 GitHub 账号登录
4. 点击 "New Project"
5. 填写项目信息：
   - **Name**: `new-year-plans-2026`
   - **Database Password**: 设置一个强密码（请记住这个密码）
   - **Region**: 选择离你最近的区域（如 Northeast Asia (Seoul)）
6. 点击 "Create new project"
7. 等待项目创建完成（通常需要 1-2 分钟）

## 步骤 2: 获取 API 密钥

1. 进入项目后，点击左侧菜单的 **Settings** > **API**
2. 复制以下两个值：
   - **Project URL**: 类似 `https://xxxxxxxxxxxxx.supabase.co`
   - **anon public key**: 类似 `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`

## 步骤 3: 配置本地环境变量

1. 在项目根目录创建 `.env.local` 文件（复制 `.env.example`）：
   ```bash
   cp .env.example .env.local
   ```

2. 编辑 `.env.local` 文件，填入刚才复制的值：
   ```env
   REACT_APP_SUPABASE_URL=https://xxxxxxxxxxxxx.supabase.co
   REACT_APP_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
   ```

3. 重启开发服务器：
   ```bash
   npm start
   ```

## 步骤 4: 创建数据库表

1. 在 Supabase 控制台，点击左侧菜单的 **SQL Editor**
2. 点击 "New query"
3. 粘贴以下 SQL 代码并点击 "Run"：

```sql
-- 创建 plans 表
CREATE TABLE plans (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  progress INTEGER DEFAULT 0 CHECK (progress >= 0 AND progress <= 100),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 创建索引以提高查询性能
CREATE INDEX idx_plans_user_id ON plans(user_id);
CREATE INDEX idx_plans_created_at ON plans(created_at DESC);

-- 创建自动更新 updated_at 的触发器
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_plans_updated_at
  BEFORE UPDATE ON plans
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

## 步骤 5: 配置行级安全策略（RLS）

RLS（Row Level Security）确保用户只能访问自己的数据。

1. 在 SQL Editor 中运行以下代码：

```sql
-- 启用 RLS
ALTER TABLE plans ENABLE ROW LEVEL SECURITY;

-- 用户只能查看自己的计划
CREATE POLICY "Users can view own plans"
ON plans FOR SELECT
USING (auth.uid() = user_id);

-- 用户只能插入自己的计划
CREATE POLICY "Users can insert own plans"
ON plans FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- 用户只能更新自己的计划
CREATE POLICY "Users can update own plans"
ON plans FOR UPDATE
USING (auth.uid() = user_id);

-- 用户只能删除自己的计划
CREATE POLICY "Users can delete own plans"
ON plans FOR DELETE
USING (auth.uid() = user_id);
```

## 步骤 6: 启用邮箱认证

1. 在 Supabase 控制台，点击左侧菜单的 **Authentication** > **Providers**
2. 确保 **Email** 提供商已启用
3. 点击 "Email" 进行配置：
   - **Confirm email**: 建议关闭（开发阶段）
   - **Secure email change**: 保持开启
4. 点击 "Save"

## 步骤 7: 配置 GitHub Pages 部署（可选）

如果你要部署到 GitHub Pages，需要配置环境变量：

1. 在 GitHub 仓库中，进入 **Settings** > **Secrets and variables** > **Actions**
2. 点击 "New repository secret"
3. 添加以下 secrets：
   - **Name**: `REACT_APP_SUPABASE_URL`
   - **Value**: 你的 Supabase Project URL
4. 再次点击 "New repository secret"
5. 添加：
   - **Name**: `REACT_APP_SUPABASE_ANON_KEY`
   - **Value**: 你的 Supabase anon public key

## 测试应用

1. 启动应用：
   ```bash
   npm start
   ```

2. 在浏览器中打开 http://localhost:3000

3. 你应该看到登录页面，点击 "没有账户？点击注册" 创建新账户

4. 注册后，你可以：
   - 添加计划
   - 编辑计划
   - 删除计划
   - 退出登录后重新登录，数据依然存在

## 常见问题

### Q: 注册后收到确认邮件？
A: 在开发阶段，你可以在 Supabase 控制台的 **Authentication** > **Users** 中手动确认用户邮箱，或者关闭邮箱确认功能。

### Q: 如何查看数据库中的数据？
A: 在 Supabase 控制台，点击 **Table Editor** > **plans** 表查看所有数据。

### Q: 数据没有同步？
A: 检查浏览器控制台是否有错误，确保 Supabase 配置正确，并且 RLS 策略已正确设置。

### Q: 如何删除测试数据？
A: 在 SQL Editor 中运行：
   ```sql
   DELETE FROM plans WHERE user_id = 'your_user_id';
   ```

## 安全建议

1. **永远不要**将 `service_role` 密钥提交到代码仓库
2. 只使用 `anon` 密钥在客户端
3. 始终启用 RLS 策略
4. 定期备份你的 Supabase 项目

## 下一步

- [ ] 添加密码重置功能
- [ ] 添加社交登录（Google、GitHub）
- [ ] 添加数据导出功能
- [ ] 添加计划分享功能
- [ ] 添加实时协作功能

---

如需帮助，请访问 [Supabase 文档](https://supabase.com/docs)